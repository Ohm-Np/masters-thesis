---
title: "benchmark - vector operations"
author: "Om Prakash Bhandari"
date: "31/03/2022"
output: html_document
---

#### Polygons - area of interest (aoi)

1. wdpa polygons (7495)
2. simplified wdpa polygons (4722)
3. fishnet gridded cells (216425)

Let's see how these three different aoi polygons look like:

```{r leafletdata, message=FALSE, warning=FALSE, include=FALSE}

library("sf")
library("terra")
library("leaflet")
library("exactextractr")
library("tidyverse")
library("tidyr")
library("ggplot2")
library("leaflet")
library("leaflet.extras")
library("leaflet.extras2")
library("ggsci")
library("scales")
library("htmltools")
library("RColorBrewer")
library("plotly")
library("rmarkdown")
library("magrittr")

# load WDPA polygon
pa.sf <- read_sf("../../datalake/mapme.protectedareas/input/wdpa_kfw/wdpa_kfw_spatial_latinamerica_2021-04-22_allPAs_valid.gpkg")
pa.sf <- st_transform(pa.sf, 4326)

# load simplified WDPA polygon
spa.sf <- read_sf("../../datalake/mapme.protectedareas/input/wdpa_kfw/wdpa_kfw_spatial_latinamerica_2021-04-22_allPAs_valid_simplified.gpkg")
spa.sf <- st_transform(spa.sf, 4326)

# load fishnet polygons
fishnet.sf <- read_sf("../../datalake/mapme.protectedareas/processing/fishnet/honeycomb_5_sqkm_kfw.gpkg")
fishnet.sf <- st_transform(fishnet.sf, 4326)


# subset data for only map
pa_map <- pa.sf %>%
  dplyr::filter(ISO3 %in% "DOM")
spa_map <- spa.sf %>%
  dplyr::filter(ISO3 %in% "DOM")
fish_map <- st_crop(fishnet.sf, pa_map)
# visualize
my_map <-
  leaflet() %>%
  addTiles(group = "OpenStreetMap") %>%
  addProviderTiles(providers$CartoDB.Positron, group="CartoDB") %>%
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>%
  addPolygons(data = pa_map,opacity = 0.9,color = "orange", group = "WDPA polygons",label = ~htmlEscape(WDPAID),weight = 1)%>%
  addPolygons(data = spa_map,opacity = 1,color = "green", group = "Simplified WDPA polygons",label = ~htmlEscape(WDPAID),weight = 1)%>%
  addPolygons(data = fish_map,opacity = 1,color = "blue", group = "Fishnets",label = ~htmlEscape(poly_id),weight = 1)%>%
  addFullscreenControl() %>%
  addLayersControl(
    baseGroups = c("CartoDB", "Satellite"),
    overlayGroups = c("WDPA polygons","Simplified WDPA polygons","Fishnets"),
    options = layersControlOptions(collapsed = FALSE))

```

```{r map, message=FALSE, warning=FALSE, include=TRUE}

my_map
```


```{r eco, message=FALSE, warning=FALSE, include=FALSE}

# load ecoregions
eco <- 
  read_sf("../../datalake/mapme.protectedareas/input/teow/Terrestrial_Ecoregions_World_02_11_2021_validated.gpkg")
eco <- st_transform(eco, 4326)

# 1. crop for whole polygon at once
t1 <- Sys.time()
cropped <- st_crop(eco, pa.sf)
t2 <- Sys.time()
diff = as.numeric(t2-t1, units="secs")

# 2. crop simplified polygon at once
t1 <- Sys.time()
cropped <- st_crop(eco, spa.sf)
t2 <- Sys.time()
diff2 = as.numeric(t2-t1, units="secs")

# 3. crop fishnet at once
t1 <- Sys.time()
cropped <- st_crop(eco, fishnet.sf)
t2 <- Sys.time()
diff3 = as.numeric(t2-t1, units="secs")
```

#### Time taken to crop ecoregion polygons by these three aois

```{r plot, message=FALSE, warning=FALSE, include=FALSE}

df.result <- data.frame(Function = "st_crop",
                        WDPA = diff,
                        Simplified_WDPA = diff2,
                        Fishnet = diff3)
df.result.long <- pivot_longer(df.result,
                               cols = c("WDPA", "Simplified_WDPA", "Fishnet"))
result.plot <- ggplot(data = df.result.long, aes(x=reorder(name, -value), y=value, fill=Function)) + 
  geom_col(position = 'dodge') +
  xlab('Type of Polygons') +
  ylab('Time elapsed (s)') +
  ggtitle('comparison of time taken to crop global ecoregion polygons')
```

```{r plot2, message=FALSE, warning=FALSE, include = TRUE, fig.width = 12}

result.plot
```


Similarly, lets try to see how this trend goes if we keep on decreasing the number of polygons meanwhile increasing the areas keeping the same extent.


#### Grid polygons - area of interest (aoi)

1. 5 sqkm grids (255020)
2. 10 sqkm grids (127600)
3. 25 sqkm grids (51336)
4. 50 sqkm grids (25839)
5. 100 sqkm grids (12950)
6. 200 sqkm grids (6600)
7. 500 sqkm grids (2688)
8. 1000 sqkm grids (1350)
9. 5000 sqkm grids (294)
10. 10000 sqkm grids (157)

Let's see how these three different aoi polygons look like:

```{r leafletdata2, message=FALSE, warning=FALSE, include=FALSE}

pa_map <- pa.sf %>%
  dplyr::filter(WDPAID %in% 31)
# spatial filter, as wkt:
wkt <- st_as_text(st_geometry(pa_map))
# filter by (bbox overlaps of) first feature geometry:
t5 <- read_sf("data/fishnet_5_sqkm.gpkg", wkt_filter = wkt)
t10 <- read_sf("data/fishnet_10_sqkm.gpkg", wkt_filter = wkt)
t25 <- read_sf("data/fishnet_25_sqkm.gpkg", wkt_filter = wkt)
t50 <- read_sf("data/fishnet_50_sqkm.gpkg", wkt_filter = wkt)
t100 <- read_sf("data/fishnet_100_sqkm.gpkg", wkt_filter = wkt)
t200 <- read_sf("data/fishnet_200_sqkm.gpkg", wkt_filter = wkt)
t500 <- read_sf("data/fishnet_500_sqkm.gpkg", wkt_filter = wkt)
t1000 <- read_sf("data/fishnet_1000_sqkm.gpkg", wkt_filter = wkt)
t5000 <- read_sf("data/fishnet_5000_sqkm.gpkg", wkt_filter = wkt)
t10000 <- read_sf("data/fishnet_10000_sqkm.gpkg", wkt_filter = wkt)


# visualize
my_map2 <-
  leaflet() %>%
  addTiles(group = "OpenStreetMap") %>%
  addProviderTiles(providers$CartoDB.Positron, group="CartoDB") %>%
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>%
  addPolygons(data = t5,opacity = 0.9,color = "orange", group = "fishnet_5",weight = 1)%>%
  addPolygons(data = t10,opacity = 1,color = "green", group = "fishnet_10",weight = 1)%>%
  addPolygons(data = t25,opacity = 1,color = "blue", group = "fishnet_25",weight = 1)%>%
  addPolygons(data = t50,opacity = 1,color = "red", group = "fishnet_50",weight = 1)%>%
  addPolygons(data = t100,opacity = 1,color = "#80e5e5", group = "fishnet_100",weight = 1)%>%
  addPolygons(data = t200,opacity = 0.9,color = "#f2d59f", group = "fishnet_200",weight = 1)%>%
  addPolygons(data = t500,opacity = 1,color = "#9fbbf2", group = "fishnet_500",weight = 1)%>%
  addPolygons(data = t1000,opacity = 1,color = "#28a9af", group = "fishnet_1000",weight = 1)%>%
  addPolygons(data = t5000,opacity = 1,color = "#f2ad6d", group = "fishnet_5000",weight = 1)%>%
  addPolygons(data = t10000,opacity = 1,color = "#05347f", group = "fishnet_10000",weight = 1)%>%
  addFullscreenControl() %>%
  addLayersControl(
    baseGroups = c("CartoDB", "Satellite"),
    overlayGroups = c("fishnet_5","fishnet_10", "fishnet_25", "fishnet_50", "fishnet_100", "fishnet_200","fishnet_500", "fishnet_1000", "fishnet_5000", "fishnet_10000"),
    options = layersControlOptions(collapsed = FALSE))

```

```{r map2, message=FALSE, warning=FALSE, include=TRUE}

my_map2
```


```{r eco2, message=FALSE, warning=FALSE, include=FALSE}

t5 <- read_sf("data/fishnet_5_sqkm.gpkg")
t10 <- read_sf("data/fishnet_10_sqkm.gpkg")
t25 <- read_sf("data/fishnet_25_sqkm.gpkg")
t50 <- read_sf("data/fishnet_50_sqkm.gpkg")
t100 <- read_sf("data/fishnet_100_sqkm.gpkg")
t200 <- read_sf("data/fishnet_200_sqkm.gpkg")
t500 <- read_sf("data/fishnet_500_sqkm.gpkg")
t1000 <- read_sf("data/fishnet_1000_sqkm.gpkg")
t5000 <- read_sf("data/fishnet_5000_sqkm.gpkg")
t10000 <- read_sf("data/fishnet_10000_sqkm.gpkg")

library(parallel)
stats <- lapply(c(t5, t10, t25, t50, t100, t200, t500, t1000, t5000, t10000), function(j) {
  t1 <- Sys.time()
  cropped <- st_crop(eco, j)
  t2 <- Sys.time()
  diff <- as.numeric(t2 - t1, units = "secs")
})
zstats <- unlist(stats)

```


#### Time taken to crop ecoregion polygons by these ten different sized fishnets

```{r plott, message=FALSE, warning=FALSE, include=FALSE}

df.result2 <- data.frame(Function = "st_crop",
                        hexa_5 = zstats[[1]],
                        hexa_10 = zstats[[2]],
                        hexa_25 = zstats[[3]],
                        hexa_50 = zstats[[4]],
                        hexa_100 = zstats[[5]],
                        hexa_200 = zstats[[6]],
                        hexa_500 = zstats[[7]],
                        hexa_1000 = zstats[[8]],
                        hexa_5000 = zstats[[9]],
                        hexa_10000 = zstats[[10]])
df.result.long2 <- pivot_longer(df.result2,
                               cols = c("hexa_5", "hexa_10", "hexa_25", "hexa_50", "hexa_100", "hexa_200", "hexa_500", "hexa_1000", "hexa_5000", "hexa_10000"))
result.plot2 <- ggplot(data = df.result.long2, aes(x=reorder(name, -value), y=value, fill=Function)) + 
  geom_col(position = 'dodge') +
  xlab('Type of Polygons') +
  ylab('Time elapsed (s)') +
  ggtitle('comparison of time taken to crop global ecoregion polygons (all polygons at once)')
```

```{r plott2, message=FALSE, warning=FALSE, include = TRUE, fig.width = 12}

result.plot2
```



Since, we did not see any significant differences on the results, now lets take only one polygon at a time.

```{r singlepol, message=FALSE, warning=FALSE, include=FALSE}

stats <- lapply(c(t5[1, ], t10[1, ], t25[1, ], t50[1, ], t100[1, ], t200[1, ], t500[1, ], t1000[1, ], t5000[1, ], t10000[1, ]), function(j) {
  t1 <- Sys.time()
  cropped <- st_crop(eco, j)
  t2 <- Sys.time()
  diff <- as.numeric(t2 - t1, units = "secs")
})
zstats <- unlist(stats)

df.result3 <- data.frame(Function = "st_crop",
                        hexa_5 = zstats[[1]],
                        hexa_10 = zstats[[2]],
                        hexa_25 = zstats[[3]],
                        hexa_50 = zstats[[4]],
                        hexa_100 = zstats[[5]],
                        hexa_200 = zstats[[6]],
                        hexa_500 = zstats[[7]],
                        hexa_1000 = zstats[[8]],
                        hexa_5000 = zstats[[9]],
                        hexa_10000 = zstats[[10]])
df.result.long3 <- pivot_longer(df.result3,
                               cols = c("hexa_5", "hexa_10", "hexa_25", "hexa_50", "hexa_100", "hexa_200", "hexa_500", "hexa_1000", "hexa_5000", "hexa_10000"))
result.plot3 <- ggplot(data = df.result.long3, aes(x=reorder(name, -value), y=value, fill=Function)) + 
  geom_col(position = 'dodge') +
  xlab('Type of Polygons') +
  ylab('Time elapsed (s)') +
  ggtitle('comparison of time taken to crop global ecoregion polygons (one polygon each)')
```

```{r plottt2, message=FALSE, warning=FALSE, include = TRUE, fig.width = 12}

result.plot3
```


### st_intersection on single polygon (fishnets)

```{r eco3, message=FALSE, warning=FALSE, include=FALSE}

t5 <- read_sf("data/fishnet_5_sqkm.gpkg")
t10 <- read_sf("data/fishnet_10_sqkm.gpkg")
t25 <- read_sf("data/fishnet_25_sqkm.gpkg")
t50 <- read_sf("data/fishnet_50_sqkm.gpkg")
t100 <- read_sf("data/fishnet_100_sqkm.gpkg")
t200 <- read_sf("data/fishnet_200_sqkm.gpkg")
t500 <- read_sf("data/fishnet_500_sqkm.gpkg")
t1000 <- read_sf("data/fishnet_1000_sqkm.gpkg")
t5000 <- read_sf("data/fishnet_5000_sqkm.gpkg")
t10000 <- read_sf("data/fishnet_10000_sqkm.gpkg")

library(parallel)
stats <- lapply(c(t5[1,], t10[1,], t25[1,], t50[1,], t100[1,], t200[1,], t500[1,], t1000[1,], t5000[1,], t10000[1,]), function(j) {
  t1 <- Sys.time()
  cropped <- st_intersection(eco, j)
  t2 <- Sys.time()
  diff <- as.numeric(t2 - t1, units = "secs")
})
zstats <- unlist(stats)


df.result4 <- data.frame(Function = "st_intersection",
                        hexa_5 = zstats[[1]],
                        hexa_10 = zstats[[2]],
                        hexa_25 = zstats[[3]],
                        hexa_50 = zstats[[4]],
                        hexa_100 = zstats[[5]],
                        hexa_200 = zstats[[6]],
                        hexa_500 = zstats[[7]],
                        hexa_1000 = zstats[[8]],
                        hexa_5000 = zstats[[9]],
                        hexa_10000 = zstats[[10]])
df.result.long4 <- pivot_longer(df.result4,
                               cols = c("hexa_5", "hexa_10", "hexa_25", "hexa_50", "hexa_100", "hexa_200", "hexa_500", "hexa_1000", "hexa_5000", "hexa_10000"))
result.plot4 <- ggplot(data = df.result.long4, aes(x=reorder(name, -value), y=value, fill=Function)) + 
  geom_col(position = 'dodge') +
  xlab('Type of Polygons') +
  ylab('Time elapsed (s)') +
  ggtitle('comparison of time taken to intersect global ecoregion polygons (one polygon at a time)')
```

```{r plottt3, message=FALSE, warning=FALSE, include = TRUE, fig.width = 12}

result.plot4
```
